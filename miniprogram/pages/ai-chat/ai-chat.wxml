<view class="container">
  <!-- å¯¹è¯åŒºåŸŸ -->
  <scroll-view class="chat-area" scroll-y scroll-into-view="{{scrollIntoView}}" scroll-with-animation>
    <!-- é¢˜ç›®å¡ç‰‡ï¼ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼‰ -->
    <view class="question-card">
      <view class="card-header">
        <view class="subject-badge">{{question.subject}}</view>
        <view class="knowledge-badge">{{question.knowledgePoint}}</view>
      </view>

      <view class="question-content-box">
        <text class="content-label">é¢˜ç›®å†…å®¹</text>
        <text class="content-text">{{question.content || 'åŠ è½½ä¸­...'}}</text>
      </view>

      <image wx:if="{{question.imageUrl}}" class="question-img" src="{{question.imageUrl}}" mode="widthFix"></image>
    </view>

    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <view wx:if="{{messages.length === 0}}" class="welcome-msg">
      <text class="ai-avatar-emoji">ğŸ¤–</text>
      <text class="welcome-title">AIè€å¸ˆåœ¨çº¿</text>
      <text class="welcome-text">æˆ‘ä¼šæ ¹æ®è¿™é“é¢˜æ¥å›ç­”ä½ çš„é—®é¢˜ï¼Œæœ‰ä»€ä¹ˆä¸æ‡‚çš„å°½ç®¡é—®æˆ‘ï½</text>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:for="{{messages}}" wx:key="index" id="msg-{{index}}" class="message-item {{item.role}}">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view wx:if="{{item.role === 'user'}}" class="user-message">
        <view class="message-bubble">
          <text class="message-text">{{item.content}}</text>
        </view>
        <view class="avatar user-avatar-placeholder">ğŸ‘¤</view>
      </view>

      <!-- AIæ¶ˆæ¯ -->
      <view wx:else class="ai-message">
        <view class="avatar ai-avatar-emoji">ğŸ¤–</view>
        <view class="message-bubble">
          <!-- æ€è€ƒä¸­ -->
          <view wx:if="{{item.isThinking}}" class="thinking">
            <text class="thinking-text">{{item.content}}</text>
            <view class="thinking-dots">
              <text class="dot">.</text>
              <text class="dot">.</text>
              <text class="dot">.</text>
            </view>
          </view>

          <!-- æ­£å¸¸æ¶ˆæ¯ -->
          <view wx:else>
            <text class="message-text">{{item.content}}</text>

            <!-- è¯­éŸ³æ’­æ”¾æŒ‰é’® -->
            <view wx:if="{{item.hasVoice}}" class="voice-btn" bindtap="playVoice" data-file-id="{{item.voiceFileID}}" data-index="{{index}}">
              <image class="voice-icon" src="/images/{{currentPlayingId === index && isPlaying ? 'pause' : 'play'}}.png" mode="aspectFit"></image>
              <text class="voice-text">{{currentPlayingId === index && isPlaying ? 'æš‚åœ' : 'æ’­æ”¾'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å ä½å…ƒç´ ï¼ˆç”¨äºæ»šåŠ¨ï¼‰ -->
    <view style="height: 20px;"></view>
  </scroll-view>

  <!-- åº•éƒ¨è¾“å…¥åŒº -->
  <view class="input-area">
    <!-- è¯­éŸ³å›å¤å¼€å…³ -->
    <view class="voice-switch-bar">
      <view class="switch-item" bindtap="toggleVoiceOutput">
        <text class="switch-icon">{{voiceOutputEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
        <text class="switch-text">{{voiceOutputEnabled ? 'AIè¯­éŸ³å›å¤' : 'AIæ–‡å­—å›å¤'}}</text>
      </view>
    </view>

    <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
    <view class="input-box">
      <!-- å·¦ä¾§ï¼šè¯­éŸ³/é”®ç›˜å›¾æ ‡ -->
      <view class="voice-icon-btn" bindtap="toggleInputMode">
        <text class="wave-icon">{{inputMode === 'voice' ? 'âŒ¨ï¸' : 'ğŸ¤'}}</text>
      </view>

      <!-- ä¸­é—´ï¼šè¾“å…¥æ¡†æˆ–è¯­éŸ³æŒ‰é’® -->
      <view class="input-wrapper">
        <!-- è¯­éŸ³æ¨¡å¼ -->
        <button
          wx:if="{{inputMode === 'voice'}}"
          class="voice-press-btn {{isRecording ? 'recording' : ''}}"
          bindtouchstart="startRecording"
          bindtouchend="stopRecording"
        >
          {{isRecording ? 'æ¾å¼€ å‘é€' : 'æŒ‰ä½ è¯´è¯'}}
        </button>

        <!-- æ–‡å­—æ¨¡å¼ -->
        <input
          wx:else
          class="text-input"
          value="{{inputValue}}"
          bindinput="onInputChange"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          confirm-type="send"
          bindconfirm="sendTextMessage"
          adjust-position="{{true}}"
        />
      </view>

      <!-- å‘é€æŒ‰é’®å·²ç§»é™¤ï¼Œä½¿ç”¨é”®ç›˜å‘é€é”® -->
    </view>
  </view>
</view>
