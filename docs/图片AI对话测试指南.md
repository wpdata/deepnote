# 图片题目AI对话功能测试指南

## ✅ 部署状态

### 已成功部署的云函数

1. **chatWithAI**
   - 部署时间：2025-10-31 16:39:23
   - 状态：Active ✅
   - 更新内容：智能模型选择、图片处理、多模态消息支持

2. **callQwenVL**
   - 部署时间：2025-10-31 16:39:30
   - 状态：Active ✅
   - 更新内容：支持完整消息历史、多轮对话

## 🧪 测试场景

### 场景 1：有图片的题目（核心修复场景）

**测试步骤：**
1. 打开小程序
2. 进入「错题本」页面
3. 选择一个**包含图片**的错题（例如数学几何题、物理图表题等）
4. 点击「AI 对话」按钮进入对话页面
5. 发送消息："请帮我分析这道题"

**预期结果：**
- ✅ 不再报错 `Failed to load local image resource`
- ✅ AI 能够理解图片中的题目内容
- ✅ 控制台日志显示：`✓ 检测到图片，使用 qwen-vl-max 视觉模型`
- ✅ AI 回复包含对图片内容的准确描述和分析

**验证点：**
- 图片题目能正常对话 ✅
- AI 回复质量高（能看懂图片）✅
- 无 500 错误 ✅

---

### 场景 2：数学题（无图片）

**测试步骤：**
1. 进入一个**数学题**（纯文字，无图片）
2. 点击「AI 对话」
3. 发送消息："这道题怎么做？"

**预期结果：**
- ✅ 使用 `qwen-math-turbo` 专业数学模型
- ✅ 控制台日志显示：`✓ 检测到数学题（无图片），使用 qwen-math-turbo 模型`
- ✅ 获得专业的数学解答

**验证点：**
- 正确选择数学专业模型 ✅
- 解答质量高（数学推理准确）✅

---

### 场景 3：其他学科题目

**测试步骤：**
1. 进入**语文/英语/物理**等其他学科题目
2. 点击「AI 对话」
3. 发送消息

**预期结果：**
- ✅ 使用 `deepseek-chat` 通用模型
- ✅ 控制台日志显示：`✓ 使用 deepseek-chat 通用模型`
- ✅ 对话流畅

**验证点：**
- 模型选择正确 ✅
- 成本优化（不使用高级模型）✅

---

### 场景 4：多轮对话（有图片）

**测试步骤：**
1. 在**有图片**的题目中进入 AI 对话
2. 第一轮："这道题考查什么知识点？"
3. 第二轮："能详细讲解一下吗？"
4. 第三轮："有没有类似的题目？"

**预期结果：**
- ✅ 每轮对话都能理解图片内容
- ✅ AI 能记住上下文（多轮连贯对话）
- ✅ 所有对话都使用 `qwen-vl-max` 模型

**验证点：**
- 图片持续可见 ✅
- 上下文连贯 ✅
- 无重复发送图片 ✅

---

## 🔍 日志查看

### 查看云函数日志

1. **在微信开发者工具中查看：**
   - 打开「云开发控制台」
   - 进入「云函数」→ `chatWithAI`
   - 查看「运行日志」

2. **关键日志标识：**
   ```
   ✓ 获取图片临时链接成功
   ✓ 检测到图片，使用 qwen-vl-max 视觉模型
   调用Qwen-VL, 模型: qwen-vl-max, 消息数: X
   ```

3. **错误日志（如果有）：**
   ```
   获取图片链接失败: [错误详情]
   Qwen视觉模型调用失败
   ```

---

## 🐛 常见问题排查

### 问题 1：仍然报错 "Qwen Math调用失败"

**原因：** 小程序缓存了旧代码

**解决方法：**
1. 在微信开发者工具中点击「清缓存」→「清除全部缓存」
2. 重新编译小程序
3. 重启微信开发者工具

---

### 问题 2：图片无法加载

**原因：** 云存储临时链接获取失败

**排查步骤：**
1. 检查云函数日志，查看 `getTempFileURL` 是否成功
2. 确认图片确实已上传到云存储
3. 检查云存储权限配置

**临时解决：**
- 等待 2-5 秒后重试
- 检查网络连接

---

### 问题 3：AI 回复不包含图片分析

**原因：** 可能使用了错误的模型

**排查步骤：**
1. 查看云函数日志，确认使用了 `qwen-vl-max` 模型
2. 检查 `imagePublicUrl` 是否成功获取
3. 检查 `error.imageUrl` 字段是否存在

---

## 📊 性能监控

### 模型调用统计

在测试过程中，关注以下指标：

1. **响应时间：**
   - 视觉模型（qwen-vl-max）：预期 3-8 秒
   - 数学模型（qwen-math-turbo）：预期 2-5 秒
   - 通用模型（deepseek-chat）：预期 2-4 秒

2. **成功率：**
   - 应该达到 95%+ 的成功率
   - 偶尔失败应该有明确的错误提示

3. **模型选择准确性：**
   - 有图片 → 100% 使用视觉模型
   - 数学题（无图片）→ 100% 使用数学模型
   - 其他 → 100% 使用通用模型

---

## ✨ 预期改进效果

### 修复前
- ❌ 有图片的题目无法进行 AI 对话
- ❌ 报错：`Failed to load local image resource`
- ❌ 500 Internal Server Error
- ❌ 用户体验受阻

### 修复后
- ✅ 有图片的题目可以正常对话
- ✅ AI 能够理解图片内容并提供分析
- ✅ 智能选择最合适的模型
- ✅ 成本优化（按需使用高级模型）
- ✅ 流畅的用户体验

---

## 📝 测试报告模板

测试完成后，请记录以下信息：

```markdown
## 测试报告

**测试时间：** 2025-10-31

**测试人：** [姓名]

### 场景 1：有图片的题目
- [ ] 测试通过
- [ ] 遇到问题：[描述问题]

### 场景 2：数学题（无图片）
- [ ] 测试通过
- [ ] 遇到问题：[描述问题]

### 场景 3：其他学科
- [ ] 测试通过
- [ ] 遇到问题：[描述问题]

### 场景 4：多轮对话
- [ ] 测试通过
- [ ] 遇到问题：[描述问题]

### 总体评价
- 功能完成度：___%
- 用户体验：[好/中/差]
- 是否发现新问题：[是/否]

### 建议改进
1. [建议 1]
2. [建议 2]
```

---

## 🎯 下一步优化建议

1. **缓存优化**
   - 缓存图片临时链接（2小时有效期内复用）
   - 减少 `getTempFileURL` 调用次数

2. **错误降级**
   - 视觉模型失败时，降级到文本模型
   - 提供友好的错误提示

3. **流式输出**
   - 支持 AI 回复的流式传输
   - 提升用户等待体验

4. **更多专业模型**
   - 物理模型、化学模型等
   - 根据学科自动选择

5. **用户反馈**
   - 添加"回答质量"评分
   - 收集用户对模型选择的满意度
