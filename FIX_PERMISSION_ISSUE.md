# 云函数权限问题修复指南

## 问题现象
调用云函数时报错：`Error: errCode: -601034 | errMsg: 没有权限，请先开通云开发或者云托管`

## 问题原因
小程序可能没有正确关联到云开发环境 `deepnote-3g0lr0fb3ce6ea1c`

## 解决步骤

### 1. 在微信开发者工具中检查云开发环境关联

1. 打开微信开发者工具
2. 点击工具栏上的「云开发」按钮
3. 在弹出的云开发控制台中，检查当前环境是否为：`deepnote-3g0lr0fb3ce6ea1c`
4. 如果不是，需要切换或关联正确的环境

### 2. 手动关联云开发环境

**方法一：通过项目设置**
1. 在微信开发者工具中，点击右上角「详情」
2. 选择「本地设置」标签
3. 找到「云开发环境ID」，填入：`deepnote-3g0lr0fb3ce6ea1c`
4. 保存并重新编译

**方法二：通过云开发控制台**
1. 点击工具栏「云开发」按钮
2. 在控制台中点击「设置」图标
3. 选择或输入环境ID：`deepnote-3g0lr0fb3ce6ea1c`
4. 点击确认

### 3. 检查 AppID 是否正确

确认 `project.config.json` 中的 `appid` 字段为：`wx4c9005e8a8ca37c0`

这个 AppID 必须已经开通了云开发功能。

### 4. 重新编译小程序

1. 在微信开发者工具中点击「编译」按钮
2. 或使用快捷键：`Ctrl/Cmd + B`
3. 查看控制台输出，确认云开发初始化成功

### 5. 验证云函数调用

打开调试器（Console），查看日志：
- 应该看到：`App Launch - 初始化云开发`
- 应该看到：`云开发初始化成功`
- 不应该有：`云开发初始化失败`

## 已完成的修复

✅ 云函数安全规则已设置为允许所有用户调用
✅ 移除了页面中重复的云开发初始化代码
✅ 增强了 app.js 中的初始化日志
✅ 云函数本身测试正常（控制台调用成功）

## 如果问题仍然存在

请检查：
1. 小程序基础库版本是否 >= 2.2.3
2. 是否在真机上测试？真机需要添加到体验者列表
3. 网络是否正常
4. 云开发环境是否欠费或被停用

## 测试命令

在微信开发者工具的 Console 中运行：

```javascript
wx.cloud.callFunction({
  name: 'getUserStats',
  success: res => console.log('成功:', res),
  fail: err => console.error('失败:', err)
})
```

如果成功，应该返回用户统计数据。
